package net.onebean.uag.conf.service.impl;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import com.alibaba.fastjson.serializer.SerializerFeature;import net.onebean.core.BasePaginationResponse;import net.onebean.server.mngt.api.model.UpSteamSyncNodeVo;import net.onebean.server.mngt.api.service.UpSteamInfoApi;import net.onebean.uag.conf.common.ConfPathHelper;import net.onebean.uag.conf.service.ManualUpdateServerNodeService;import net.onebean.uag.conf.service.UpgradeNginxConfService;import net.onebean.uag.conf.vo.ConfResult;import net.onebean.util.CollectionUtil;import net.onebean.util.FreeMarkerTemplateUtils;import net.onebean.util.IOUtils;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.nio.file.Paths;import java.util.Collections;import java.util.List;import java.util.Optional;@Servicepublic class ManualUpdateServerNodeServiceImpl implements ManualUpdateServerNodeService {    private final static Logger logger = LoggerFactory.getLogger(ManualUpdateServerNodeServiceImpl.class);    private final static Boolean IS_SYNC_UPDATE_NGINX = false;    private final static String UPSTREAM_FTL_PATH = "/upstream/upstream.ftl";    @Autowired    private UpgradeNginxConfService upgradeNginxConfService;    @Autowired    private UpSteamInfoApi upSteamInfoApi;    @Override    public Boolean updateAllNginxUpSteamConf() {        /*查询可用的upsteam节点 生成upsteam.conf文件*/        ConfResult confResult = generateUpstream(this.getAllUpSteamNode());        /*异步更新nginx节点配置*/        upgradeNginxConfService.updateAllRemoteNginxConf(confResult.getCoverFiles(), confResult.getRemoveFiles(), IS_SYNC_UPDATE_NGINX);        return true;    }    @Override    public ConfResult generateUpstream(List<UpSteamSyncNodeVo> upSteamNodeVos) {        logger.info("生成upstream.conf文件：" + JSON.toJSONString(upSteamNodeVos, SerializerFeature.WriteMapNullValue));        /*在本地创建目录*/        IOUtils.mkDir(ConfPathHelper.getLocalConfDir());        /*生成对应内容 并写成文件*/        ConfResult confResult = new ConfResult();        JSONObject param = new JSONObject();        param.put("marathons", upSteamNodeVos);        String localUpstreamPath = Paths.get(ConfPathHelper.getLocalBasePath(), "conf.d", "upstream.conf").toFile().getAbsolutePath();        FreeMarkerTemplateUtils.generateFile(param,localUpstreamPath,UPSTREAM_FTL_PATH);        /*返回生成的文件记录*/        confResult.addCoverFile(ConfPathHelper.getEcsRelativePath(localUpstreamPath));        return confResult;    }    @SuppressWarnings("unchecked")    @Override    public List<UpSteamSyncNodeVo> getAllUpSteamNode() {        BasePaginationResponse<UpSteamSyncNodeVo> resp = upSteamInfoApi.findSyncUpSteamNode();        List<UpSteamSyncNodeVo> list = Optional.ofNullable(resp).map(BasePaginationResponse::getDatas).orElse(null);        if (CollectionUtil.isNotEmpty(list)){            return list;        }else{            logger.warn("getAllUpSteamNode findSyncUpSteamNode res is empty");            return Collections.EMPTY_LIST;        }    }}